<div class="row" >
  <div class="col-sm-5">
    <%= md 'intro' %>
  </div>
  <div class="col-sm-7">

    <a href="https://blockscout.com/poa/xdai/tokens/0xcaE40062a887581A3d1661d0AC2b481c32e3E938/token-holders">Token balances from Blockscout</a>

    <table class="table mt-3">
      <thead>
        <tr>
          <th>
            #
          </th>
          <th>
            Ethereum/xDai address
          </th>
          <th>
            AUT
          </th>
        </tr>
      </thead
  </table>
      <%
a = Mechanize.new

items = []

j = JSON.parse(a.get('https://blockscout.com/poa/xdai/tokens/0xcaE40062a887581A3d1661d0AC2b481c32e3E938/token-transfers?type=JSON').body)

while j
  items += j['items']
  puts items.count
  break if !j['next_page_path']
  j = JSON.parse(a.get(j['next_page_path']+'&type=JSON').body)
end

balances = {}

items.each { |item|

h = Nokogiri::HTML(item)
from = h.search('[data-address-hash]')[0].attr('data-address-hash')
to = h.search('[data-address-hash]')[1].attr('data-address-hash')
tokens = h.search('.tile-title').text.split(' ').first.gsub(',','').to_f

balances[from] = 0 if !balances[from]
balances[to] = 0 if !balances[to]
balances[from] -= tokens
balances[to] += tokens

}

balances = balances.select { |k,v| v > 0 }.sort_by { |k,v| -v }

balances.each_with_index { |b,i|
  eth, balance = b
%>
      <tr>
        <th>#<%=i+1%></th>
        <td><a target="_blank" href="https://blockscout.com/poa/xdai/address/<%=eth%>/tokens"><%=eth%></a></td>
        <td><%=balance%></td>
      </tr>
      <% } %>
    </table>

  </div>
</div>
